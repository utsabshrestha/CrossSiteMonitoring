
@model FullReport

@{
    ViewBag.Title = "Report Edit Page";
    var district = ViewData["district"]?.ToString() ?? null;
    var road_code = ViewData["road_code"]?.ToString() ?? null;
    var initial = Model.inital.Any() ? Model.inital.ElementAt(0) : null;
    var message = ViewData["message"]?.ToString() ?? null;
}

@* For the Notification*@
<div class="notifyme">
    <div class="toast notifyme-in" role="alert" aria-live="assertive" aria-atomic="true" data-delay="1700" data-autohide="true">
        <div class="toast-header">
            <strong class="mr-auto text-primary">CrossSiteMonitoring</strong>
            <small class="text-muted">Just now</small>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="toast-body" id="msg">  Hey, there! This is a Bootstrap 4 toast. </div>
    </div>
</div>



@if (Model.inital.Any())
{
    <div class="container">
        <div class="row">
            <div class="col-md-2 pt-5">
                <div class="list-group list-group-flush sticky-top" style="top: 90px;z-index: 5">
                    <form method="post" class="mb-2 list-group-item">
                        <input asp-for="@road_code" name="road_code" type="hidden" />
                        <input asp-for="@district" name="district" type="hidden" />
                        <button asp-action="ListRoadDetail" type="submit" class="btn btn-sm styleMy">Go Back</button>
                    </form>
                    <form method="post" class="mb-2 list-group-item">
                        <input asp-for="@district" name="districtSelected" type="hidden" />
                        <button asp-action="ListRoads" type="submit" class="btn btn-sm styleMy">Site Visit <br />  @district</button>
                    </form>
                </div>
            </div>
            <div class="col-md-8 page">
                <h3 class="card-title align-items-center text-primary text-center">Construction Site Visit Report</h3>
                <h6 class="card-subtitle text-muted text-center">@initial.road_name</h6>


                <div class="mt-5">
                    <div class="row">
                        <div class="col-sm-8">
                            <h4 class="card-subtitle text-muted">Initial Detials</h4>
                        </div>
                        <div class="col-sm-4">
                            <h6 class="card-subtitle text-muted">Date : @initial.date.ToShortDateString()</h6>
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="form-group row">
                        <label for="ObserverName" class="col-sm-4 col-form-label">Observer Name</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control-plaintext" asp-for="@initial.observer_name" name="observer_name" readonly>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="Designation" class="col-sm-4 col-form-label">Designation</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control-plaintext" asp-for="@initial.designation" name="designation" readonly>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="inputEmail3" class="col-sm-4 col-form-label">Observer Email</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control-plaintext" asp-for="@initial.observer_email" name="observer_email" readonly>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="district" class="col-sm-4 col-form-label">District</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control-plaintext" asp-for="@initial.district" readonly>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="RoadCode" class="col-sm-4 col-form-label">Road Code</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control-plaintext" asp-for="@initial.road_code" readonly>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label for="RoadNmae" class="col-sm-4 col-form-label">Road Nmae</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control-plaintext" asp-for="@initial.road_name" readonly>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <br />
                    <br />
                    <h4 class="card-subtitle text-muted">Construction Observation Detials</h4>
                    <div class="dropdown-divider"></div>

                    @{ 
                        var ObserCount = 0;
                    }

                    @foreach (var report in Model.constructionObservations)
                    {
                        ObserCount++;

                        <br />
                        <h6 class="card-subtitle text-muted">Observation @ObserCount</h6>
                        <br />

                        <form method="post" id="@report.form_id" asp-action="UpdateInitials">

                            <div class="form-group row">
                                <label for="ObserverName" class="col-sm-4 col-form-label">Construction Type</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" asp-for="@report.construction_type" name="construction_type" required>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="ObserverName" class="col-sm-4 col-form-label">Location</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" asp-for="@report.location" name="location" required>
                                </div>
                            </div><div class="form-group row">
                                <label for="ObserverName" class="col-sm-4 col-form-label">Observation Notes</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" asp-for="@report.observation_notes" name="observation_notes" required>
                                </div>
                            </div><div class="form-group row">
                                <label for="ObserverName" class="col-sm-4 col-form-label">Quality Rating</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" asp-for="@report.quality_rating" name="quality_rating" required>
                                </div>
                            </div>
                            <input type="hidden" class="form-control" asp-for="@report.form_id" name="form_id">
                            <input type="hidden" class="form-control" asp-for="@report.uuid" name="uuid">
                            <input type="hidden" class="form-control" asp-for="@report.road_code" name="road_code">
                            <input type="hidden" class="form-control" asp-for="@initial.observer_email" name="observer_email">

                            <div class="form-group row">
                                <div class="col-sm-4">
                                    <a href="javascript:void(0);" class="btn btn-primary" onclick="Update('@report.form_id','@ObserCount')">Update Observation @ObserCount</a>
                                </div>
                            </div>

                        </form>
                    }
                </div>




            </div>


            <div class="col-md-2 pt-5">
                <div class="list-group list-group-flush sticky-top" style="top: 90px;z-index: 5">
                    <div class="mb-2 list-group-item">
                        <form asp-action="ViewReport" method="post" class="mb-2 list-group-item">
                            <input value="@initial.form_id" name="form_id" type="hidden" />
                            <input value="@initial.road_code" name="road_code" type="hidden" />
                            <input value="@initial.date" name="date" type="hidden" />
                            <input value="@initial.observer_email" name="observer_email" type="hidden" />
                            <button class="btn btn-sm styleMy" type="submit" style="padding: 0px;" formtarget="_blank">View Report</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

}


<script>
    let myStatus = null;
    let msg = document.getElementById("msg");

    async function Update(id, Obserno) {
        let data = document.getElementById(id);
        let formData = new FormData(data);
        let __RequestVerificationToken = formData.get("__RequestVerificationToken");
        $('#exampleModal').modal('hide');

        const dataJson = {};
        for (var pair of formData.entries()) {
            if (pair[0] == "__RequestVerificationToken")
                continue;
            dataJson[pair[0]] = pair[1];
        }
        console.log(dataJson);
        await postData('https://localhost:5001/Dashboard/UpdateInitials', dataJson, __RequestVerificationToken)
            .then(data => {
                if (myStatus == 200) {
                    msg.innerHTML = `Observation${Obserno} has been updated.`;
                    msg.innerHTML = data.message;

                    $('.toast-header').css("background-color", "white");
                } else {
                    $('.toast-header').css("background-color", "red");
                    msg.innerHTML = data.message;

                }
                $('.toast').toast('show');
            });
    }

    async function postData(url = '', data = {}, RqVeTkn) {
        // Default options are marked with *
        const response = await fetch(url, {
            method: 'POST', // *GET, POST, PUT, DELETE, etc.
            mode: 'cors', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omits
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': RqVeTkn
            },
            redirect: 'follow', // manual, *follow, error
            referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
            body: JSON.stringify(data)// body data type must match "Content-Type" header
        });
        myStatus = response.status;
        return response.json(); // parses JSON response into native JavaScript objects
    }
</script>